unit EmissaoController;

interface

uses
  Horse,
  System.JSON,
  EventDispatcher,
  DocumentoEmitidoHandler,
  DocumentoFiscalDTO;

type
  TEmissaoController = class
  private
    FDispatcher: TEventDispatcher;
  protected
    procedure EmitirDocumento(Req: THorseRequest; Res: THorseResponse);
  public
    class function New: TEmissaoController;

    procedure RegisterController;
  end;

implementation

{ TEmissaoController }

procedure TEmissaoController.EmitirDocumento(Req: THorseRequest;
  Res: THorseResponse);
begin
  var LDocumento := TDocumentoFiscalDTO.Create;
  try
    LDocumento.Numero := Req.Body<TJSONObject>.GetValue<String>('numero');
    LDocumento.ValorTotal := Req.Body<TJSONObject>.GetValue<Double>('valorTotal');

    // Despachar evento de documento emitido

  finally
    LDocumento.Free;
  end;
end;

class function TEmissaoController.New: TEmissaoController;
begin
  Result := Self.Create;
end;

procedure TEmissaoController.RegisterController;
begin
  FDispatcher := TEventDispatcher.Create;

  THorse
    .Post('/emitir', EmitirDocumento);
end;

end.
